name: Notify Versions

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Resolve compatible versions
      # -------------------------------------------------
      - name: Resolve versions
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          MORPHE_YT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? | select(type=="array") | .[]' | sort -V | tail -n1)
          MORPHE_MUSIC=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? | select(type=="array") | .[]' | sort -V | tail -n1)
          MORPHE_REDDIT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.reddit.frontpage"]? | select(type=="array") | .[]' | sort -V | tail -n1)

          ANDDEA_YT=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? | select(type=="array") | .[]' | sort -V | tail -n1)
          ANDDEA_MUSIC=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? | select(type=="array") | .[]' | sort -V | tail -n1)

          echo "MORPHE_YT=$MORPHE_YT" >> $GITHUB_ENV
          echo "MORPHE_MUSIC=$MORPHE_MUSIC" >> $GITHUB_ENV
          echo "MORPHE_REDDIT=$MORPHE_REDDIT" >> $GITHUB_ENV
          echo "ANDDEA_YT=$ANDDEA_YT" >> $GITHUB_ENV
          echo "ANDDEA_MUSIC=$ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # Build APKMirror links (FIXED)
      # -------------------------------------------------
      - name: Build links
        run: |
          build_link () {
            VERSION="$1"
            BASE="$2"
            if [ -n "$VERSION" ]; then
              SLUG=$(echo "$VERSION" | tr '.' '-')
              echo "${BASE}-${SLUG}-release/"
            fi
          }

          MORPHE_YT_LINK=$(build_link "$MORPHE_YT" "https://www.apkmirror.com/apk/google-inc/youtube/youtube")
          MORPHE_MUSIC_LINK=$(build_link "$MORPHE_MUSIC" "https://www.apkmirror.com/apk/google-inc/youtube-music/youtube-music")
          MORPHE_REDDIT_LINK=$(build_link "$MORPHE_REDDIT" "https://www.apkmirror.com/apk/redditinc/reddit/reddit")

          ANDDEA_YT_LINK=$(build_link "$ANDDEA_YT" "https://www.apkmirror.com/apk/google-inc/youtube/youtube")
          ANDDEA_MUSIC_LINK=$(build_link "$ANDDEA_MUSIC" "https://www.apkmirror.com/apk/google-inc/youtube-music/youtube-music")

          echo "MORPHE_YT_LINK=$MORPHE_YT_LINK" >> $GITHUB_ENV
          echo "MORPHE_MUSIC_LINK=$MORPHE_MUSIC_LINK" >> $GITHUB_ENV
          echo "MORPHE_REDDIT_LINK=$MORPHE_REDDIT_LINK" >> $GITHUB_ENV
          echo "ANDDEA_YT_LINK=$ANDDEA_YT_LINK" >> $GITHUB_ENV
          echo "ANDDEA_MUSIC_LINK=$ANDDEA_MUSIC_LINK" >> $GITHUB_ENV

      # -------------------------------------------------
      # Send Telegram (Preview Disabled)
      # -------------------------------------------------
      - name: Send Telegram
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          TEXT="Version Update Detected"

          TEXT="$TEXT"$'\n\nMorphe:'
          TEXT="$TEXT"$'\nYouTube: ${MORPHE_YT:-N/A}'
          TEXT="$TEXT"$'\nMusic: ${MORPHE_MUSIC:-N/A}'
          TEXT="$TEXT"$'\nReddit: ${MORPHE_REDDIT:-N/A}'

          TEXT="$TEXT"$'\n\nAnddea:'
          TEXT="$TEXT"$'\nYouTube: ${ANDDEA_YT:-N/A}'
          TEXT="$TEXT"$'\nMusic: ${ANDDEA_MUSIC:-N/A}'

          TEXT="$TEXT"$'\n\nDownload Links:'

          [ -n "$MORPHE_YT_LINK" ] && TEXT="$TEXT"$'\nMorphe YT: '"$MORPHE_YT_LINK"
          [ -n "$MORPHE_MUSIC_LINK" ] && TEXT="$TEXT"$'\nMorphe Music: '"$MORPHE_MUSIC_LINK"
          [ -n "$MORPHE_REDDIT_LINK" ] && TEXT="$TEXT"$'\nMorphe Reddit: '"$MORPHE_REDDIT_LINK"

          [ -n "$ANDDEA_YT_LINK" ] && TEXT="$TEXT"$'\nAnddea YT: '"$ANDDEA_YT_LINK"
          [ -n "$ANDDEA_MUSIC_LINK" ] && TEXT="$TEXT"$'\nAnddea Music: '"$ANDDEA_MUSIC_LINK"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d disable_web_page_preview=true \
            --data-urlencode text="${TEXT}"

      # -------------------------------------------------
      # Update versions.txt
      # -------------------------------------------------
      - name: Update versions.txt
        run: |
          {
            echo "MORPHE_YT=${MORPHE_YT:-}"
            echo "MORPHE_MUSIC=${MORPHE_MUSIC:-}"
            echo "MORPHE_REDDIT=${MORPHE_REDDIT:-}"
            echo "ANDDEA_YT=${ANDDEA_YT:-}"
            echo "ANDDEA_MUSIC=${ANDDEA_MUSIC:-}"
          } > versions.txt

      # -------------------------------------------------
      # Commit with Dynamic Message
      # -------------------------------------------------
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add versions.txt

          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          MSG="chore: "

          [ -n "$MORPHE_YT" ] && MSG="${MSG}Morphe YT ${MORPHE_YT} | "
          [ -n "$MORPHE_MUSIC" ] && MSG="${MSG}Morphe Music ${MORPHE_MUSIC} | "
          [ -n "$MORPHE_REDDIT" ] && MSG="${MSG}Morphe Reddit ${MORPHE_REDDIT} | "
          [ -n "$ANDDEA_YT" ] && MSG="${MSG}Anddea YT ${ANDDEA_YT} | "
          [ -n "$ANDDEA_MUSIC" ] && MSG="${MSG}Anddea Music ${ANDDEA_MUSIC}"

          git commit -m "$MSG"
          git push origin main
