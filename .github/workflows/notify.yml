name: Notify Versions

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Resolve compatible versions (SAFE jq)
      # -------------------------------------------------
      - name: Resolve versions
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          MORPHE_YT=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.youtube"]?
            | select(type=="array")
            | .[]
          ' | sort -V | tail -n 1)

          MORPHE_MUSIC=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.apps.youtube.music"]?
            | select(type=="array")
            | .[]
          ' | sort -V | tail -n 1)

          MORPHE_REDDIT=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.reddit.frontpage"]?
            | select(type=="array")
            | .[]
          ' | sort -V | tail -n 1)

          ANDDEA_YT=$(curl -s "$ANDDEA_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.youtube"]?
            | select(type=="array")
            | .[]
          ' | sort -V | tail -n 1)

          ANDDEA_MUSIC=$(curl -s "$ANDDEA_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.apps.youtube.music"]?
            | select(type=="array")
            | .[]
          ' | sort -V | tail -n 1)

          echo "MORPHE_YT=$MORPHE_YT" >> $GITHUB_ENV
          echo "MORPHE_MUSIC=$MORPHE_MUSIC" >> $GITHUB_ENV
          echo "MORPHE_REDDIT=$MORPHE_REDDIT" >> $GITHUB_ENV
          echo "ANDDEA_YT=$ANDDEA_YT" >> $GITHUB_ENV
          echo "ANDDEA_MUSIC=$ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # Build APKMirror links safely
      # -------------------------------------------------
      - name: Build links
        run: |
          if [ -n "$MORPHE_YT" ]; then
            YT_SLUG=$(echo "$MORPHE_YT" | tr '.' '-')
            YT_LINK="https://www.apkmirror.com/apk/google-inc/youtube/youtube-${YT_SLUG}-release/"
          fi

          if [ -n "$MORPHE_MUSIC" ]; then
            MUSIC_SLUG=$(echo "$MORPHE_MUSIC" | tr '.' '-')
            MUSIC_LINK="https://www.apkmirror.com/apk/google-inc/youtube-music/youtube-music-${MUSIC_SLUG}-release/"
          fi

          if [ -n "$MORPHE_REDDIT" ]; then
            REDDIT_SLUG=$(echo "$MORPHE_REDDIT" | tr '.' '-')
            REDDIT_LINK="https://www.apkmirror.com/apk/redditinc/reddit/reddit-${REDDIT_SLUG}-release/"
          fi

          echo "YT_LINK=$YT_LINK" >> $GITHUB_ENV
          echo "MUSIC_LINK=$MUSIC_LINK" >> $GITHUB_ENV
          echo "REDDIT_LINK=$REDDIT_LINK" >> $GITHUB_ENV

      # -------------------------------------------------
      # Send Telegram Notification
      # -------------------------------------------------
      - name: Send Telegram
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          TEXT="Version Update Detected"

          TEXT="$TEXT"$'\n\n'"Morphe:"
          TEXT="$TEXT"$'\n'"YouTube: ${MORPHE_YT:-N/A}"
          TEXT="$TEXT"$'\n'"Music: ${MORPHE_MUSIC:-N/A}"
          TEXT="$TEXT"$'\n'"Reddit: ${MORPHE_REDDIT:-N/A}"

          TEXT="$TEXT"$'\n\n'"Anddea:"
          TEXT="$TEXT"$'\n'"YouTube: ${ANDDEA_YT:-N/A}"
          TEXT="$TEXT"$'\n'"Music: ${ANDDEA_MUSIC:-N/A}"

          TEXT="$TEXT"$'\n\n'"Download Links:"
          [ -n "$YT_LINK" ] && TEXT="$TEXT"$'\n'"YouTube: $YT_LINK"
          [ -n "$MUSIC_LINK" ] && TEXT="$TEXT"$'\n'"Music: $MUSIC_LINK"
          [ -n "$REDDIT_LINK" ] && TEXT="$TEXT"$'\n'"Reddit: $REDDIT_LINK"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            --data-urlencode text="${TEXT}"

      # -------------------------------------------------
      # Update versions.txt
      # -------------------------------------------------
      - name: Update versions.txt
        run: |
          {
            echo "MORPHE_YT=${MORPHE_YT:-}"
            echo "MORPHE_MUSIC=${MORPHE_MUSIC:-}"
            echo "MORPHE_REDDIT=${MORPHE_REDDIT:-}"
            echo "ANDDEA_YT=${ANDDEA_YT:-}"
            echo "ANDDEA_MUSIC=${ANDDEA_MUSIC:-}"
          } > versions.txt

      # -------------------------------------------------
      # Commit with Dynamic Message
      # -------------------------------------------------
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add versions.txt

          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          MSG="chore: "
          [ -n "$MORPHE_YT" ] && MSG="${MSG}Morphe YT ${MORPHE_YT} | "
          [ -n "$MORPHE_MUSIC" ] && MSG="${MSG}Morphe Music ${MORPHE_MUSIC} | "
          [ -n "$MORPHE_REDDIT" ] && MSG="${MSG}Morphe Reddit ${MORPHE_REDDIT} | "
          [ -n "$ANDDEA_YT" ] && MSG="${MSG}Anddea YT ${ANDDEA_YT} | "
          [ -n "$ANDDEA_MUSIC" ] && MSG="${MSG}Anddea Music ${ANDDEA_MUSIC}"

          git commit -m "$MSG"
          git push origin main
