name: Version Watcher

on:
  workflow_dispatch:
  schedule:
    - cron: "30 16 * * *"   # 10 PM IST

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # STEP 1 — Fetch latest compatible versions
      # -------------------------------------------------
      - name: Fetch latest versions
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          echo "Fetching Morphe JSON..."
          MORPHE_JSON=$(curl -s "$MORPHE_SOURCE")

          echo "Fetching Anddea JSON..."
          ANDDEA_JSON=$(curl -s "$ANDDEA_SOURCE")

          NEW_MORPHE_YT=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.youtube"]?
            | .[]?
          ' | sort -V | tail -n 1)

          NEW_MORPHE_MUSIC=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.apps.youtube.music"]?
            | .[]?
          ' | sort -V | tail -n 1)

          NEW_MORPHE_REDDIT=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.reddit.frontpage"]?
            | .[]?
          ' | sort -V | tail -n 1)

          NEW_ANDDEA_YT=$(echo "$ANDDEA_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.youtube"]?
            | .[]?
          ' | sort -V | tail -n 1)

          NEW_ANDDEA_MUSIC=$(echo "$ANDDEA_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.apps.youtube.music"]?
            | .[]?
          ' | sort -V | tail -n 1)

          echo "NEW_MORPHE_YT=$NEW_MORPHE_YT" >> $GITHUB_ENV
          echo "NEW_MORPHE_MUSIC=$NEW_MORPHE_MUSIC" >> $GITHUB_ENV
          echo "NEW_MORPHE_REDDIT=$NEW_MORPHE_REDDIT" >> $GITHUB_ENV
          echo "NEW_ANDDEA_YT=$NEW_ANDDEA_YT" >> $GITHUB_ENV
          echo "NEW_ANDDEA_MUSIC=$NEW_ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # STEP 2 — Compare with versions.txt (SAFE)
      # -------------------------------------------------
      - name: Compare with versions.txt
        id: compare
        run: |
          set -e

          echo "---- NEW VALUES ----"
          echo "NEW_MORPHE_YT=$NEW_MORPHE_YT"
          echo "NEW_MORPHE_MUSIC=$NEW_MORPHE_MUSIC"
          echo "NEW_MORPHE_REDDIT=$NEW_MORPHE_REDDIT"
          echo "NEW_ANDDEA_YT=$NEW_ANDDEA_YT"
          echo "NEW_ANDDEA_MUSIC=$NEW_ANDDEA_MUSIC"
          echo "--------------------"

          if [ ! -f versions.txt ]; then
            echo "versions.txt not found"
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          MORPHE_YT=$(grep '^MORPHE_YT=' versions.txt | cut -d= -f2 || true)
          MORPHE_MUSIC=$(grep '^MORPHE_MUSIC=' versions.txt | cut -d= -f2 || true)
          MORPHE_REDDIT=$(grep '^MORPHE_REDDIT=' versions.txt | cut -d= -f2 || true)
          ANDDEA_YT=$(grep '^ANDDEA_YT=' versions.txt | cut -d= -f2 || true)
          ANDDEA_MUSIC=$(grep '^ANDDEA_MUSIC=' versions.txt | cut -d= -f2 || true)

          echo "---- OLD VALUES ----"
          echo "MORPHE_YT=$MORPHE_YT"
          echo "MORPHE_MUSIC=$MORPHE_MUSIC"
          echo "MORPHE_REDDIT=$MORPHE_REDDIT"
          echo "ANDDEA_YT=$ANDDEA_YT"
          echo "ANDDEA_MUSIC=$ANDDEA_MUSIC"
          echo "--------------------"

          CHANGED=false

          [ "$NEW_MORPHE_YT" != "$MORPHE_YT" ] && CHANGED=true
          [ "$NEW_MORPHE_MUSIC" != "$MORPHE_MUSIC" ] && CHANGED=true
          [ "$NEW_MORPHE_REDDIT" != "$MORPHE_REDDIT" ] && CHANGED=true
          [ "$NEW_ANDDEA_YT" != "$ANDDEA_YT" ] && CHANGED=true
          [ "$NEW_ANDDEA_MUSIC" != "$ANDDEA_MUSIC" ] && CHANGED=true

          echo "CHANGED=$CHANGED"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # STEP 3 — Trigger notify.yml only if mismatch
      # -------------------------------------------------
      - name: Trigger notify workflow
        if: steps.compare.outputs.changed == 'true'
        run: |
          echo "Version mismatch detected. Triggering notify.yml..."
          gh workflow run notify.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
