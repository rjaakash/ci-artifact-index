name: Version Watcher

on:
  workflow_dispatch:
  schedule:
    - cron: "30 16 * * *"   # 10 PM IST

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # STEP 1 — Fetch latest versions from patches JSON
      # -------------------------------------------------
      - name: Fetch latest compatible versions
        id: fetch
        run: |
          set -e

          SOURCE_URL="PUT_YOUR_PATCHES_JSON_LINK_HERE"

          JSON=$(curl -s "$SOURCE_URL")

          MORPHE_YT=$(echo "$JSON" | jq -r '
            (.patches[]? 
              | .compatiblePackages?["com.google.android.youtube"]? 
              | .[]?) // empty
          ' | sort -V | tail -n 1)

          MORPHE_MUSIC=$(echo "$JSON" | jq -r '
            (.patches[]? 
              | .compatiblePackages?["com.google.android.apps.youtube.music"]? 
              | .[]?) // empty
          ' | sort -V | tail -n 1)

          MORPHE_REDDIT=$(echo "$JSON" | jq -r '
            (.patches[]? 
              | .compatiblePackages?["com.reddit.frontpage"]? 
              | .[]?) // empty
          ' | sort -V | tail -n 1)

          ANDDEA_YT=$(echo "$JSON" | jq -r '
            (.patches[]? 
              | .compatiblePackages?["app.revanced.android.youtube"]? 
              | .[]?) // empty
          ' | sort -V | tail -n 1)

          ANDDEA_MUSIC=$(echo "$JSON" | jq -r '
            (.patches[]? 
              | .compatiblePackages?["app.revanced.android.youtube.music"]? 
              | .[]?) // empty
          ' | sort -V | tail -n 1)

          echo "MORPHE_YT=$MORPHE_YT" >> $GITHUB_ENV
          echo "MORPHE_MUSIC=$MORPHE_MUSIC" >> $GITHUB_ENV
          echo "MORPHE_REDDIT=$MORPHE_REDDIT" >> $GITHUB_ENV
          echo "ANDDEA_YT=$ANDDEA_YT" >> $GITHUB_ENV
          echo "ANDDEA_MUSIC=$ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # STEP 2 — Compare with versions.txt
      # -------------------------------------------------
      - name: Compare with versions.txt
        id: compare
        run: |
          set -e

          if [ ! -f versions.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          source versions.txt

          CHANGED=false

          [ "$MORPHE_YT" != "$MORPHE_YT" ] && CHANGED=true
          [ "$MORPHE_MUSIC" != "$MORPHE_MUSIC" ] && CHANGED=true
          [ "$MORPHE_REDDIT" != "$MORPHE_REDDIT" ] && CHANGED=true
          [ "$ANDDEA_YT" != "$ANDDEA_YT" ] && CHANGED=true
          [ "$ANDDEA_MUSIC" != "$ANDDEA_MUSIC" ] && CHANGED=true

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # STEP 3 — Trigger notify.yml only if mismatch
      # -------------------------------------------------
      - name: Trigger notify workflow
        if: steps.compare.outputs.changed == 'true'
        run: gh workflow run notify.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
