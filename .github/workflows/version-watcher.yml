name: Version Watcher

on:
  workflow_dispatch:
  schedule:
    # 10:00 PM IST = 16:30 UTC
    - cron: "30 16 * * *"

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    outputs:
      changed: ${{ steps.compare.outputs.changed }}

    steps:
      - uses: actions/checkout@v4

      - name: Resolve latest compatible versions
        id: resolve
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          NEW_MORPHE_YT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? // empty | .[]' | sort -V | tail -n 1)
          NEW_MORPHE_MUSIC=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty | .[]' | sort -V | tail -n 1)
          NEW_MORPHE_REDDIT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.reddit.frontpage"]? // empty | .[]' | sort -V | tail -n 1)

          NEW_ANDDEA_YT=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? // empty | .[]' | sort -V | tail -n 1)
          NEW_ANDDEA_MUSIC=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty | .[]' | sort -V | tail -n 1)

          {
            echo "NEW_MORPHE_YT=$NEW_MORPHE_YT"
            echo "NEW_MORPHE_MUSIC=$NEW_MORPHE_MUSIC"
            echo "NEW_MORPHE_REDDIT=$NEW_MORPHE_REDDIT"
            echo "NEW_ANDDEA_YT=$NEW_ANDDEA_YT"
            echo "NEW_ANDDEA_MUSIC=$NEW_ANDDEA_MUSIC"
          } >> $GITHUB_ENV

      - name: Compare with stored versions
        id: compare
        run: |
          if [ ! -f versions.txt ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          source versions.txt

          CHANGED=false

          if [ "$NEW_MORPHE_YT" != "$MORPHE_YT" ]; then CHANGED=true; fi
          if [ "$NEW_MORPHE_MUSIC" != "$MORPHE_MUSIC" ]; then CHANGED=true; fi
          if [ "$NEW_MORPHE_REDDIT" != "$MORPHE_REDDIT" ]; then CHANGED=true; fi
          if [ "$NEW_ANDDEA_YT" != "$ANDDEA_YT" ]; then CHANGED=true; fi
          if [ "$NEW_ANDDEA_MUSIC" != "$ANDDEA_MUSIC" ]; then CHANGED=true; fi

          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

  notify:
    needs: check
    if: needs.check.outputs.changed == 'true'
    uses: ./.github/workflows/notify.yml
