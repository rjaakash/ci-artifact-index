name: Version Watcher

on:
  # Manual trigger
  workflow_dispatch:

  # 10:00 PM IST = 16:30 UTC
  schedule:
    - cron: "30 16 * * *"

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      # =================================================
      # Checkout repository
      # Required to read versions.txt
      # =================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =================================================
      # Resolve latest compatible versions
      # - Morphe
      # - Anddea
      # =================================================
      - name: Check latest compatible versions
        id: versioncheck
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          # -----------------------
          # Fetch latest versions
          # -----------------------
          LATEST_MORPHE_YT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? // empty | .[]' | sort -V | tail -n 1)
          LATEST_MORPHE_MUSIC=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty | .[]' | sort -V | tail -n 1)
          LATEST_MORPHE_REDDIT=$(curl -s "$MORPHE_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.reddit.frontpage"]? // empty | .[]' | sort -V | tail -n 1)

          LATEST_ANDDEA_YT=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.youtube"]? // empty | .[]' | sort -V | tail -n 1)
          LATEST_ANDDEA_MUSIC=$(curl -s "$ANDDEA_SOURCE" | jq -r '.patches[] | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty | .[]' | sort -V | tail -n 1)

          # -----------------------
          # Safety Guard
          # -----------------------
          if [ -z "$LATEST_MORPHE_YT" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "Patch source returned empty. Skipping."
            exit 0
          fi

          # -----------------------
          # Read stored versions
          # -----------------------
          source versions.txt 2>/dev/null || true

          CHANGED=false

          if [ "$LATEST_MORPHE_YT" != "$MORPHE_YT" ]; then CHANGED=true; fi
          if [ "$LATEST_MORPHE_MUSIC" != "$MORPHE_MUSIC" ]; then CHANGED=true; fi
          if [ "$LATEST_MORPHE_REDDIT" != "$MORPHE_REDDIT" ]; then CHANGED=true; fi
          if [ "$LATEST_ANDDEA_YT" != "$ANDDEA_YT" ]; then CHANGED=true; fi
          if [ "$LATEST_ANDDEA_MUSIC" != "$ANDDEA_MUSIC" ]; then CHANGED=true; fi

          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      # =================================================
      # Trigger notify workflow
      # =================================================
      - name: Trigger notify workflow
        if: steps.versioncheck.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run "Notify Versions"
