name: Version Watcher

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled trigger (Runs daily at 22:00 UTC)
  schedule:
    - cron: "0 22 * * *"

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repository
      # Required to read versions.txt
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Resolve latest compatible versions (Morphe + Anddea)
      # -------------------------------------------------
      - name: Resolve latest compatible versions
        id: resolve
        run: |
          set -e

          # ---------------------------
          # MORPHE SOURCE
          # ---------------------------
          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"

          MORPHE_YT=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.youtube"]? // empty
            | .[]
          ' | sort -V | tail -n 1)

          MORPHE_MUSIC=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty
            | .[]
          ' | sort -V | tail -n 1)

          MORPHE_REDDIT=$(curl -s "$MORPHE_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.reddit.frontpage"]? // empty
            | .[]
          ' | sort -V | tail -n 1)

          # ---------------------------
          # ANDDEA SOURCE
          # ---------------------------
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          ANDDEA_YT=$(curl -s "$ANDDEA_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.youtube"]? // empty
            | .[]
          ' | sort -V | tail -n 1)

          ANDDEA_MUSIC=$(curl -s "$ANDDEA_SOURCE" | jq -r '
            .patches[]
            | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty
            | .[]
          ' | sort -V | tail -n 1)

          echo "MORPHE_YT=$MORPHE_YT" >> $GITHUB_ENV
          echo "MORPHE_MUSIC=$MORPHE_MUSIC" >> $GITHUB_ENV
          echo "MORPHE_REDDIT=$MORPHE_REDDIT" >> $GITHUB_ENV
          echo "ANDDEA_YT=$ANDDEA_YT" >> $GITHUB_ENV
          echo "ANDDEA_MUSIC=$ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # Compare with versions.txt
      # -------------------------------------------------
      - name: Compare with stored versions
        id: compare
        run: |
          set -e

          # Load current stored values (if file missing, treat as empty)
          source versions.txt 2>/dev/null || true

          CHANGED=false

          if [ "$MORPHE_YT" != "${MORPHE_YT:-}" ]; then CHANGED=true; fi
          if [ "$MORPHE_MUSIC" != "${MORPHE_MUSIC:-}" ]; then CHANGED=true; fi
          if [ "$MORPHE_REDDIT" != "${MORPHE_REDDIT:-}" ]; then CHANGED=true; fi
          if [ "$ANDDEA_YT" != "${ANDDEA_YT:-}" ]; then CHANGED=true; fi
          if [ "$ANDDEA_MUSIC" != "${ANDDEA_MUSIC:-}" ]; then CHANGED=true; fi

          echo "changed=$CHANGED" >> "$GITHUB_OUTPUT"

      # -------------------------------------------------
      # Trigger notify workflow if changed
      # -------------------------------------------------
      - name: Trigger notify workflow
        if: steps.compare.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run notify.yml
