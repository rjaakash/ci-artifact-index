name: Version Watcher

on:
  # -------------------------------------------------
  # Manual trigger
  # -------------------------------------------------
  workflow_dispatch:

  # -------------------------------------------------
  # Scheduled trigger
  #
  # Runs daily at 06:09 UTC
  # -------------------------------------------------
  schedule:
    - cron: "9 6 * * *"

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repository
      #
      # Required to read version tracking files
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # =================================================
      # MORPHE SECTION
      # =================================================

      - name: Resolve YouTube version from Morphe patches
        id: youtube
        run: |
          set -e
          SOURCE_URL="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"

          LATEST=$(curl -s "$SOURCE_URL" | jq -r '
              .patches[]
              | .compatiblePackages["com.google.android.youtube"]? // empty
              | .[]
            ' | sort -V | tail -n 1)

          CURRENT=$(cat youtube.txt 2>/dev/null || echo "")

          if [ -n "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve Music version from Morphe patches
        id: music
        run: |
          set -e
          SOURCE_URL="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"

          LATEST=$(curl -s "$SOURCE_URL" | jq -r '
              .patches[]
              | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty
              | .[]
            ' | sort -V | tail -n 1)

          CURRENT=$(cat music.txt 2>/dev/null || echo "")

          if [ -n "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve Reddit version from Morphe patches
        id: reddit
        run: |
          set -e
          SOURCE_URL="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"

          LATEST=$(curl -s "$SOURCE_URL" | jq -r '
              .patches[]
              | .compatiblePackages["com.reddit.frontpage"]? // empty
              | .[]
            ' | sort -V | tail -n 1)

          CURRENT=$(cat reddit.txt 2>/dev/null || echo "")

          if [ -n "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # =================================================
      # ANDDEA SECTION
      # =================================================

      - name: Resolve YouTube version from Anddea patches
        id: youtube_anddea
        run: |
          set -e
          SOURCE_URL="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          LATEST=$(curl -s "$SOURCE_URL" | jq -r '
              .patches[]
              | .compatiblePackages["com.google.android.youtube"]? // empty
              | .[]
            ' | sort -V | tail -n 1)

          CURRENT=$(cat youtube-anddea.txt 2>/dev/null || echo "")

          if [ -n "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve Music version from Anddea patches
        id: music_anddea
        run: |
          set -e
          SOURCE_URL="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          LATEST=$(curl -s "$SOURCE_URL" | jq -r '
              .patches[]
              | .compatiblePackages["com.google.android.apps.youtube.music"]? // empty
              | .[]
            ' | sort -V | tail -n 1)

          CURRENT=$(cat music-anddea.txt 2>/dev/null || echo "")

          if [ -n "$LATEST" ] && [ "$LATEST" != "$CURRENT" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      # =================================================
      # TRIGGERS
      # =================================================

      - name: Trigger YouTube sync
        if: steps.youtube.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run sync_youtube.yml

      - name: Trigger Music sync
        if: steps.music.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run sync_music.yml

      - name: Trigger Reddit sync
        if: steps.reddit.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run sync_reddit.yml

      - name: Trigger YouTube Anddea sync
        if: steps.youtube_anddea.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run sync_youtube_anddea.yml

      - name: Trigger Music Anddea sync
        if: steps.music_anddea.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run sync_music_anddea.yml
