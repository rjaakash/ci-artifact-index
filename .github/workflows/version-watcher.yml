name: Version Watcher

on:
  workflow_dispatch:
  schedule:
    - cron: "30 16 * * *"   # 10 PM IST

permissions:
  contents: read
  actions: write

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------
      # STEP 1 — Fetch latest compatible versions
      # -------------------------------------------------
      - name: Fetch latest versions
        run: |
          set -e

          MORPHE_SOURCE="https://raw.githubusercontent.com/MorpheApp/morphe-patches/main/patches-list.json"
          ANDDEA_SOURCE="https://raw.githubusercontent.com/anddea/revanced-patches/dev/patches-list.json"

          MORPHE_JSON=$(curl -s "$MORPHE_SOURCE")
          ANDDEA_JSON=$(curl -s "$ANDDEA_SOURCE")

          MORPHE_YT=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.youtube"]?[]?
          ' | sort -V | tail -n 1)

          MORPHE_MUSIC=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.apps.youtube.music"]?[]?
          ' | sort -V | tail -n 1)

          MORPHE_REDDIT=$(echo "$MORPHE_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.reddit.frontpage"]?[]?
          ' | sort -V | tail -n 1)

          ANDDEA_YT=$(echo "$ANDDEA_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.youtube"]?[]?
          ' | sort -V | tail -n 1)

          ANDDEA_MUSIC=$(echo "$ANDDEA_JSON" | jq -r '
            .patches[]?
            | .compatiblePackages?["com.google.android.apps.youtube.music"]?[]?
          ' | sort -V | tail -n 1)

          echo "NEW_MORPHE_YT=$MORPHE_YT" >> $GITHUB_ENV
          echo "NEW_MORPHE_MUSIC=$MORPHE_MUSIC" >> $GITHUB_ENV
          echo "NEW_MORPHE_REDDIT=$MORPHE_REDDIT" >> $GITHUB_ENV
          echo "NEW_ANDDEA_YT=$ANDDEA_YT" >> $GITHUB_ENV
          echo "NEW_ANDDEA_MUSIC=$ANDDEA_MUSIC" >> $GITHUB_ENV

      # -------------------------------------------------
      # STEP 2 — Compare with versions.txt
      # -------------------------------------------------
      - name: Compare with versions.txt
        id: compare
        run: |
          set -e

          if [ ! -f versions.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          source versions.txt

          CHANGED=false

          [ "$NEW_MORPHE_YT" != "$MORPHE_YT" ] && CHANGED=true
          [ "$NEW_MORPHE_MUSIC" != "$MORPHE_MUSIC" ] && CHANGED=true
          [ "$NEW_MORPHE_REDDIT" != "$MORPHE_REDDIT" ] && CHANGED=true
          [ "$NEW_ANDDEA_YT" != "$ANDDEA_YT" ] && CHANGED=true
          [ "$NEW_ANDDEA_MUSIC" != "$ANDDEA_MUSIC" ] && CHANGED=true

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # STEP 3 — Trigger notify.yml if changed
      # -------------------------------------------------
      - name: Trigger notify workflow
        if: steps.compare.outputs.changed == 'true'
        run: gh workflow run "Notify Versions"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
