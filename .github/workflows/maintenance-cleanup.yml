name: Repository Maintenance Cleanup

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Cleanup releases (keep 5 from versions.txt)
      # -------------------------------------------------
      - name: Cleanup releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          if [ ! -f versions.txt ]; then
            echo "versions.txt not found. Aborting."
            exit 1
          fi

          source versions.txt

          # Build exact keep list (5 expected)
          KEEP_TAGS=(
            "YouTube-${MORPHE_YT}"
            "YouTube-${ANDDEA_YT}"
            "Music-${MORPHE_MUSIC}"
            "Music-${ANDDEA_MUSIC}"
            "Reddit-${MORPHE_REDDIT}"
          )

          echo "Tags that must be kept:"
          printf '%s\n' "${KEEP_TAGS[@]}"

          echo "Fetching up to 100 releases..."

          gh release list --limit 100 --json tagName \
            -q '.[].tagName' \
          | while read TAG; do

              KEEP=false

              for K in "${KEEP_TAGS[@]}"; do
                if [ "$TAG" = "$K" ]; then
                  KEEP=true
                  break
                fi
              done

              if [ "$KEEP" = false ]; then
                echo "Deleting release + tag: $TAG"
                gh release delete "$TAG" --yes || true
                git push origin ":refs/tags/$TAG" || true
              else
                echo "Keeping: $TAG"
              fi

            done

      # -------------------------------------------------
      # Cleanup workflow runs
      # Fetch 300 → Keep latest 100 → Delete rest
      # -------------------------------------------------
      - name: Cleanup workflow runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching 300 workflow runs..."

          gh run list -L 300 --json databaseId,createdAt \
            -q 'sort_by(.createdAt) | reverse | .[].databaseId' \
          | tail -n +101 \
          | while read RUN_ID; do
              echo "Deleting workflow run ID: $RUN_ID"
              gh api repos/$GITHUB_REPOSITORY/actions/runs/$RUN_ID -X DELETE
            done

          echo "Workflow cleanup complete."
