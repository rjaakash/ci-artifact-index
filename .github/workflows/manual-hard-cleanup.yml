name: Repository Hard Cleanup

on:
  # Manual trigger ONLY
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Checkout repository
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Reset version tracking files
      # -------------------------------------------------
      - name: Reset versions.txt to 0
        run: |
          echo "MORPHE_YT=0" > versions.txt
          echo "MORPHE_MUSIC=0" >> versions.txt
          echo "MORPHE_REDDIT=0" >> versions.txt
          echo "ANDDEA_YT=0" >> versions.txt
          echo "ANDDEA_MUSIC=0" >> versions.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add versions.txt

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: reset version tracking to 0"
          git push origin main

      # -------------------------------------------------
      # Delete old workflow runs (keep latest 1 only)
      # -------------------------------------------------
      - name: Delete old workflow runs (keep 1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching last 300 workflow runs..."

          gh run list -L 300 --json databaseId,createdAt \
            -q 'sort_by(.createdAt) | reverse | .[].databaseId' \
          | tail -n +2 \
          | while read run_id; do
              echo "Deleting workflow run ID: $run_id"
              gh api repos/$GITHUB_REPOSITORY/actions/runs/$run_id -X DELETE
            done

          echo "Cleanup completed. Only latest workflow run kept."
