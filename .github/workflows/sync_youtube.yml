name: Sync YouTube APK

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # Repository checkout
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # Python setup
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # -------------------------------------------------
      # Install dependencies
      # -------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # -------------------------------------------------
      # Run downloader script
      # -------------------------------------------------
      - name: Download YouTube APK
        id: download
        env:
          YOUTUBE_VERSION: ${{ env.YOUTUBE_VERSION }}
        run: |
          OUTPUT=$(python scripts/sync_youtube.py)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep APK_PATH= | sed 's/APK_PATH=//' > apk_path.txt

      # -------------------------------------------------
      # Create GitHub release and upload APK
      # -------------------------------------------------
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        with:
          tag_name: YouTube-${{ env.YOUTUBE_VERSION }}
          name: YouTube-${{ env.YOUTUBE_VERSION }}
          files: |
            $(cat apk_path.txt)

      # -------------------------------------------------
      # Update version tracking file
      # -------------------------------------------------
      - name: Update youtube.txt
        if: success()
        run: |
          echo "${YOUTUBE_VERSION}" > youtube.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add youtube.txt
          git commit -m "chore(youtube): sync YouTube ${YOUTUBE_VERSION}"
          git push
